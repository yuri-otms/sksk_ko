{% extends "base.html" %}

{% block body %}

<h2>確認依頼詳細</h2>

<p><a href="{{url_for('req.index')}}">依頼インデックスへ</a></p>

<form>
<table>
    <tr>
        <th>id</th>
        <td>{{request.id}}</td>
    </tr>
    <tr>
        <th>タイトル</th>
        <td>{{request.title}}</td>
    </tr>
    <tr>
        <th>詳細</th>
        <td>{{request.detail}}</td>
    </tr>
    <tr>
        <th>依頼日時</th>
        <td>{{request.requested_at}}</td>
    </tr>
    {% if request.finished_at %}
    <tr>
        <th>完了日時</th>
        <td>{{request.finished_at}}</td>
    </tr>
    {% endif %}
</table>

{% if session['edit'] and request.finished_at == None %}
<input type="hidden" name="request_id" value="{{request.id}}">
<button formaction="{{url_for('req.delete_check_request')}}" formmethod="POST">削除</button>
{% endif %}

<h3>依頼した問題文</h3>
{% if session['check'] and request.finished_at == None%}
修正の必要ないものは「確認」にチェックをお願いします。
{% endif %}
<table>
    <tr>
        <th>id</th>
        <th>級</th>
        <th>項目</th>
        <th>日本語</th>
        <th>韓国語</th>
        {% if session['check']%}
        <th>確認</th>
        {% endif %}
        {% if session['approve'] and request.finished_at %}
        <th>公開<br>
            <label><input type="checkbox" id="checkAll" name="question">全て選択</label></th>
        {% endif %}
    </tr>
    {% for question in questions %}
    <tr>
        <td>{{question.id}}</td>
        <input type="hidden" name="questions" value="{{question.id}}">
        <td>{{question.grade}}</td>
        <td>{{question.element}}</td>
        <td>{{question.japanese}}</td>
        <td>{{question.foreign_l}}</td>
        {% if session['check'] and request.finished_at == None%}
        <td rowspan="2">
            <input type="checkbox" name="checked" value="{{question.id}}">
        </td>
        {% endif %}
        {% if request.finished_at %}
        <td rowspan="2">
            {{question.checked}}
        </td>
        {% endif %}
        {% if session['approve'] and request.finished_at %}
        <td rowspan="2"> 
            <input type="checkbox" class="checks" name="question" value="{{question.id}}">
        </td>
        {% endif %}
    </tr>
    {% if session['check'] and request.finished_at == None%}
    <tr>
        <td colspan="5">
            コメント <textarea name="message" cols="40" rows="2"></textarea>

        </td>
    </tr>
    {% endif %}
    {% if request.finished_at %}
    <tr>
        <td colspan="5">
            {% if question.message %}
            {{question.message}}
            {% else %}
            なし
            {% endif %}
        </td>
    </tr>
    {% endif %}
    {% endfor %}
</table>
{% if session['check'] and request.finished_at == None %}
<input type="hidden" name="request_id" value="{{request.id}}">
<button formaction="{{url_for('req.question_checked')}}" formmethod="POST">確認</button>
<button type="button" onclick="history.back()">戻る</button>
</form>
{% endif %}

{% if session['approve'] and request.finished_at %}
<button formaction="" formmethod="">公開</button>
<button type="button" onclick="history.back()">戻る</button>
{% endif %}

{% if session['approve'] and rejected_questions and request.request_id == 0 %}
<p><a href="{{url_for('req.resubmit_check_request', r=request.id)}}">再提出</a></p>
{% endif %}

<p><a href="{{url_for('req.index')}}">依頼インデックスへ</a></p>

<script>
    //チェックボックスを全て選択、全て解除
    let checkAll = document.getElementById("checkAll");
    let el = document.getElementsByClassName("checks");

    const funcCheckAll = (bool) => {
        for (let i = 0; i < el.length; i++) {
            el[i].checked = bool;
        }
    }
    const funcCheck = () => {
        let count = 0;
        for (let i = 0; i < el.length; i++) {
            if (el[i].checked) {
                count += 1;
            }
        }
        if (el.length == count) {
            checkAll.checked = true;
        } else {
            checkAll.checked = false;
        }
    };
    checkAll.addEventListener("click",() => {
        funcCheckAll(checkAll.checked);
    }, false)

    for (let i = 0; i < el.length; i++) {
        el[i].addEventListener("click", funcCheck, false)
    }


</script>

{% endblock %}